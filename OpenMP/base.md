# Введение в OpenMP

## Принципы

Управление выполнением производится директивами препроцессора ```#pragma```:

```c++
#pragma omp directive [args...] \
					  [more args...]
```

Вместо ```directive``` пишем нужную директиву, а после указываем параметры - в стиле функций.
А если их слишком много - можно перейти на следующую строку с помощью обратного слеша.

Директива относится только к следующему оператору - поэтому если там больше, чем одна строка, понадобятся фигурные скобки.

Весь код делится на последовательные и параллельные секции.
Это делается с помощью директивы ```parallel```:

Вместо ```args``` можно задать какие-нибудь параметры.
Например, количество нитей:

```c++
#pragma omp parallel num_threads(n)
```

Так задаётся количество потоков.

## Данные

В отличие от MPI, здесь можно и нужно использовать разделяемую память. Все переменные в параллельной секции делятся на приватные и разделённые с очевидными различиями.

По умоолчанию в категории ```private``` - всё, что объявлено внутри блока и что не помечено как static, всё остальное - ```shared```.

Но мы можем указать это в начале параллельной секции с помощью следующих параметров (в скобках перечисляем имена переменных):

- ```private``` и ```shared```. Тут вроде всё понятно, но есть один нюанс.
Когда переменная становится приватной, её значение не копируется на все нити.
Её значение до и после выполнения параллельной секции не определено. Есть две директивы, разбирающиеся с этим:
- ```lastprivate``` - значение после параллельной секции будет **последним** записанным в эту переменную в параллельной секции.
- ```firstprivate``` - значение в начале параллельной секции копируется на все нити.
- ```default``` - указывает, что делать с переменной по умолчанию - в скобках указываем директиву - ```private```, ```shared```, ```none```

### Редукционные операции

В начале секции можем задать переменную, к которой цв конце применится редукционный оператор.
В прагме задаётся по типу ```reduction (+: var) ```
Вместо плюса может быть бинарный арифметический или логический оператор, а также ```min``` или ```max```.


## Распределение работы

Есть директива ```single``` - кусок кода в этой директиве будет выполнен только одной нитью. Остальные будут ждать завершения. Или не будут, если указать опцию ```nowait```.

Есть директива ```master``` - кусок кода выполнится потоком с рангом 0.

Если нужно описать много разных активностей - есть директивы ```sections``` и ```section```:

```c++
#pragma omp parallel num_threads(3)
{
	#pragma omp sections
	{
		#pragma omp section
		{}
		#pragma omp section
		{}
		// ...
	}
}
```

Если секций столько же, сколько нитей, каждый берёт по нити. Лишние потоки ожидают. Если потоков меньше, то действует пул задач - освободившийся поток берётся за невыполненную секцию.

В конце блока будет барьерная синхронизация. Или не будет, если указать ```nowait```.

### Распараллеливание циклов

Можно автоматически распараллелить цикл с счётчиком (с константными параметрами ```start, end, step```)
Делается так:

```c++
#pragma omp parallel
{
	#pragma omp for
	for (int i = 0; i < count; ++i)
	{
		/* code */
	}
}
```

Естественно, никакая зависимость по данным не проверяется - эта директива просто разбивает итерационное пространство на секции (почти как в примере выше).
В конце, вестимо, барьерная синхронизация.
Но если использовать с умом - например, применяя редукцию где это надо - будет очень полезно.

Ещё полезно помнить директиву ```barrier``` для выполнения барьерной синхронизации и ```critical``` для выделения участка кода, который нужно выполнять не более чем одному за раз.

## Процедуры

По сравнению с опциями препроцессора их очень мало.
Следующие функции параметров не имеют, возвращают ```int``` (а не как в MPI, боже упаси):

Определить количество исполнителей в системе:

```c++
int omp_get_num_procs()
```

Определить количество работающих нитей:

```c++
int omp_get_num_threads()
```

Определить номер текущей нити:

```c++
int omp_get_thread_num()
```

Поведение последних двух процедур не определено вне параллельной секции. Обычно прокатывает, но нужно избегать.


----

[На главную](../Readme.md)